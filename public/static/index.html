<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>My Page</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.1/jquery.mobile-1.2.1.min.css" />
        <script src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
        <script src="http://code.jquery.com/mobile/1.2.1/jquery.mobile-1.2.1.min.js"></script>
        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?language=iw"></script>
        <link rel="stylesheet" type="text/css" href="./stylesheets/style.css">
    </head>

    <body dir="rtl">

        <!-- Start of first page: #mainPage -->
        <div data-role="page" id="mainPage">

            <div data-role="header" data-theme="b">
                <h1>TLV-Streets</h1>
            </div><!-- /header -->

            <div data-role="content">
                <h2 align="center">
                    <img src="static/logo.jpg"alt="TLV_Logo" height="100" width="250" align="middle">
                </h2>

                <p>
                    <a href="#searchByPage" id="buttonSearchByPage" data-role="button" data-icon="search"> חיפוש לפי</a>
                </p>
                <p>
                    <a href="#streetInfoPage" id="buttonStreetRandom" data-role="button" data-icon="star"> הידעת?</a>
                </p>
                <p>
                    <a href="#aboutUsPage" id="buttonAboutUsPage" data-role="button" data-rel="dialog" data-transition="pop" data-icon="info">מי אנחנו?</a>
                </p>
            </div><!-- /content -->

            <div data-role="footer" data-theme="d" class="ui.footer">
                <p align="center" style="font-size:70%"> המידע באדיבות עיריית תל אביב - יפו</p>
            </div><!-- /footer -->

            <script>
                $(document).ready(function() {
                    // update the streetInfo template to be random
                    $('#buttonStreetRandom').click(function () {
                        templateDisaply = templateOptions.RANDOM;
                    });
                });
            </script>

        </div><!-- /end of #mainPage -->

        <!-- Start of #searchByPage -->
        <div data-role="page" id="searchByPage">

            <div data-role="header" data-theme="b">
                <h1>חיוש לפי</h1>
            </div><!-- /header -->

            <div data-role="content" >

                <h2 align="center">

                </h2>

                <p>
                    <a href="#byNamePage" id ='buttonByNamePage' data-role="button" data-icon=""> שם רחוב</a>
                </p>
                <p>
                    <a href="#streetInfoPage" id ='buttonByLoction' data-role="button" data-icon="">המיקום שלי </a>
                </p>

                <div class="backButtonPosition">
                    <p align="center">
                        <a href="#mainPage" data-direction="reverse" data-role="button" data-icon="back" data-iconpos="notext"></a>
                    </p>

                </div>
            </div><!-- /content -->

            <div data-role="footer" data-theme="d" class="ui.footer">
                <p align="center" style="font-size:70%"> המידע באדיבות עיריית תל אביב - יפו</p>
            </div><!-- /footer -->

            <script>
                $(document).ready(function() {
                    // update the streetInfo template to be by location
                    $('#buttonByLoction').click(function(){
                        templateDisaply = templateOptions.LOCATION;
                    });
                });
            </script>
        </div><!-- /end of #searchByPage -->

        <!-- Start of #byNamePage -->
        <div data-role="page" id="byNamePage">

            <div data-role="header" data-theme="b">
                <h1>חיפוש לפי שם הרחוב</h1>
            </div><!-- /header -->

            <div data-role="content" cal>

                <h3 align="center">הכנס שם רחוב:</h3>

                <ul id="autocomplete" data-role="listview" data-inset="true" data-filter="true"  data-divider-theme="e" data-filter-placeholder="מצא רחוב" data-filter-theme="d"></ul>

                <h2 align="center">
                    <a href="#byNameResponsePage">
                        <button id="buttonSearch" onclick="getValue()" data-inline="true">חפש</button>
                    </a>
                </h2>

                <script type="text/javascript">

                    $(document).ready(function() {
                        // update the streetInfo template to be by location
                        $('#buttonByLoction').click(function(){
                            templateDisaply = templateOptions.LOCATION;
                        });
                        // update the streetInfo template to be by location
                        $('#buttonSearch').click(function(){
                            templateDisaply = templateOptions.NAME;
                        });
                    });

                    $(document).on("pageshow", "#byNamePage", function() {
                        $("#autocomplete").on("listviewbeforefilter", getPredictions);
                    });


                    function getPredictions(e, data) {
                        $("#autocomplete").off("listviewbeforefilter", getPredictions);

                        setTimeout(function () {
                            $("#autocomplete").on("listviewbeforefilter", getPredictions);
                        }, 500);

                        var $ul = $(this),
                                $input = $(data.input),
                                value = $input.val(),
                                html = "";

                        $ul.html("");

                        if (value && value.length > 2) {
                            $ul.html("<li><div class='ui-loader'><span class='ui-icon ui-icon-loading'></span></div></li>");
                            $ul.listview("refresh");

                            $.ajax({
                                url: "/predictions/" + $input.val(),
                                dataType: "text"
                            })
                                    .then(function (response) {

                                        var streets = JSON.parse(response);
                                        var html = "";

                                        $.each(streets, function (i, val) {
                                            html += "<li>" +
                                                        "<a href=\"#streetInfoPage\">" +
                                                            val +
                                                        "</a>" +
                                                    " </li>";
                                            // update the streetInfo template to be by location
                                            $('#buttonSearchResult'+i).click(setTemplateByName);
                                        });

                                        $ul.html(html);
                                        $ul.listview("refresh");
                                        $ul.trigger("updatelayout");
                                    });
                        }
                    };

                </script>

                <div class="backButtonPosition">
                    <p align="center">
                        <a href="#searchByPage" data-direction="reverse" data-role="button" data-icon="back" data-iconpos="notext"></a>
                    </p>
                </div>
            </div><!-- /content -->

            <div data-role="footer" data-theme="d" class="ui.footer">
                <p align="center" style="font-size:70%"> המידע באדיבות עיריית תל אביב - יפו</p>
            </div><!-- /footer -->

        </div><!-- /end of #byNamePage -->

        <!-- Start of #streetInfoPage -->
        <div data-role="page" id="streetInfoPage">

            <meta name="viewport" content="initial-scale=1.0, user-scalable=no">

            <div data-role="header" data-theme="b">

                <h1></h1>

            </div><!-- /header -->

            <div data-role="content">

                <div id="streetMap" align="center"></div>
                <style>
                    #streetMap {
                        height: 200px;
                        border-style: solid;
                        border-width: 5px;
                        border-color: #4f6f9a;
                    }
                </style>

                <p id="streetName" class="innerTEXT"></p>
                <br>
                <br>
                <p id="streetInfo" class="innerTEXT"></p>


                <div class="backButtonPosition">
                    <p align="center">
                        <a href="#searchByPage" data-direction="reverse" data-role="button" data-inline="true" data-icon="back" data-iconpos="notext"></a>
                    </p>
                </div>

            </div><!-- /content -->


            <div data-role="footer" data-theme="d" class="ui.footer">
                <p align="center" style="font-size:70%"> המידע באדיבות עיריית תל אביב - יפו</p>
            </div><!-- /footer -->


            <script>

                var googleMap;
                
                var templateOptions = {
                    LOCATION: 1,
                    NAME: 2,
                    RANDOM: 3
                };

                var templateDisaply = templateOptions.RANDOM;

                $(document).on("pageshow", "#streetInfoPage", function() {
                    setMap();

                    switch (templateDisaply){
                        case templateOptions.LOCATION:
                                setByLocation();
                            break;
                        case templateOptions.NAME:
                                setByName();
                            break;
                        case templateOptions.RANDOM:
                                setByRandom();
                            break;
                        default:
                            setByRandom();
                            break;
                    }
                });

                function setMap(){
                    googleMap = new google.maps.Map(document.getElementById('streetMap'), {
                        center: {lat: 32.08153566996312, lng: 34.77752322388187},
                        zoom: 8,
                        mapTypeControl: false,
                        streetViewControl: false,
                        zoomControl: false,
                        mapTypeId: google.maps.MapTypeId.ROADMAP
                    });
                };

                function setByName(){

                };

                function setByLocation(){
                    setUserLoction();

                    function setUserLoction() {

                        // Try HTML5 geolocation
                        if (navigator.geolocation) {
                            navigator.geolocation.getCurrentPosition(function(position) {

                                var pos = {
                                    lat: position.coords.latitude,
                                    lng: position.coords.longitude
                                };

                                getStreetNameFromGoogleGeo(pos);

                            }, function() {
                                alert('השרת עמוס כרגע, אנא נסה שנית בעוד מספר דקות');
                            });
                        } else {
                            alert('מכשירך אינו תומך במציאת מקום, וודא שה-GPS פעיל');
                        }
                    };

                    function getStreetNameFromGoogleGeo(pos) {
                        var geocoder = new google.maps.Geocoder();
                        var latlng = new google.maps.LatLng(pos.lat, pos.lng);

                        geocoder.geocode({'latLng': latlng}, function(results, status) {

                            var streetName;

                            if (status == google.maps.GeocoderStatus.OK) {
                                streetName = results[0].address_components[1].long_name;
                                googleMap.setCenter(results[0].geometry.location);
                                googleMap.fitBounds(results[0].geometry.bounds);

                                getAndSetStreetInfoFromServer(streetName);

                            } else {
                                alert("Geocoder failed due to: " + status);
                            }
                        });
                    };

                    function getAndSetStreetInfoFromServer(streetName){
                        $.ajax({
                            url: "/streets/" + "מנדלסון, משה",
                            dataType: "text"
                        })
                                .then(function (response) {
                                    $("#streetName").html("מנדלסון, משה" );
                                    $("#streetValue").html(response);
                                });
                    };
                };

                function setByRandom() {
                    var randomStreet;
                    $.ajax({
                        url: "/getRandomPage",
                        dataType: "text"
                    })
                            .then(function (response) {
                                randomStreet = JSON.parse(response);
                                $("#streetName").html(randomStreet.streetName);
                                $("#streetInfo").html(randomStreet.streetInfo);
                            });

                }

            </script>

        </div><!-- /end of #streetInfoPage -->


        <!-- Start of #aboutUsPage -->
        <div data-role="page" id="aboutUsPage">

            <div data-role="header" data-theme="e">
                <h1>
                    מי אנחנו?
                </h1>
            </div><!-- /header -->

            <p data-role="content" data-theme="d">
                <img src="static/street_sign_with_names.png" height="100%" width="100%">
            </p><!-- /content -->

        </div><!-- /end of #aboutUsPage -->

    </body>
</html>